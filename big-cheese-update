#!/bin/bash

set -e
set -v

# Protect site folder.
mv $PLATFORM_ROOT_LAST_INSTALL/web/sites/${PLATFORM_NAME_LAST_INSTALL}.${SERVER_URI} $PLATFORM_ROOT_LAST_INSTALL/

# Replace platform code of last installation.
rm -rf $PLATFORM_ROOT_LAST_INSTALL/web
cp -R $WORKSPACE/web $PLATFORM_ROOT_LAST_INSTALL/web

# Put site folder back.
mv $PLATFORM_ROOT_LAST_INSTALL/${PLATFORM_NAME_LAST_INSTALL}.${SERVER_URI} $PLATFORM_ROOT_LAST_INSTALL/web/sites/${PLATFORM_NAME_LAST_INSTALL}.${SERVER_URI}

# Empty all caches.
drush "${SITE_LAST_INSTALL}" cc all

# Update database.
drush "${SITE_LAST_INSTALL}" updb -y
